<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout-nickelfox}">

<head>
    <title>New Sale - NickelFox Sales System</title>
</head>

<body>
<div layout:fragment="content">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="loading-text mt-3">
                <span id="loadingMessage">Procesando...</span>
            </div>
        </div>
    </div>


    <!-- Barra de botones mejorada y alineada a la izquierda -->
    <div class="d-flex align-items-center gap-2 mb-4" style="justify-content: flex-start;">

        <button type="button" class="btn btn-outline-primary btn-icon rounded-circle shadow-sm"
                id="btnNuevoProducto" title="Nuevo"
                onclick="window.location.href='/ventas/nueva'">
            <i class="fas fa-plus"></i>
        </button>
        <button type="button" class="btn btn-outline-success btn-icon rounded-circle shadow-sm"
                th:disabled="${formularioDeshabilitado}"
                onclick="enviarFormularioAjax('guardar')"
                id="btnGuardar" title="Guardar">
            <i class="fas fa-save"></i>
        </button>
        <button type="button" class="btn btn-outline-success btn-icon rounded-circle shadow-sm"
                th:unless="${venta.estatus == T(com.salessystem.model.EstatusVenta).CONCLUIDO or venta.estatus == T(com.salessystem.model.EstatusVenta).PENDIENTE}"
                th:disabled="${formularioDeshabilitado}"
                onclick="enviarFormularioAjax('afectar')"
                id="btnAfectar" title="Afectar">
            <i class="fas fa-check-circle"></i>
        </button>
        <button type="button" class="btn btn-outline-secondary btn-icon rounded-circle shadow-sm"
                id="btnregresar" onclick="regresar()" title="Volver">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>
    <style>
        .btn-icon {
            width: 38px;
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            transition: box-shadow 0.2s;
        }
        .btn-icon:hover {
            box-shadow: 0 0 8px rgba(0,0,0,0.15);
        }
    </style>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0" th:text="${esEdicion != null ? 'Edit Sale Information' : 'Sale Information'}">Sale Information</h5>
        </div>
        <div class="card-body">
        
        <!-- Ajustes visuales locales para que el formulario de ventas coincida con productos -->
        <style>
            /* Aumenta levemente tamaño y padding solo para este formulario */
            .ventas-form-scale .form-label { font-size: 0.95rem; }
            .ventas-form-scale .form-control, .ventas-form-scale .form-select { padding: 0.5rem 0.75rem; font-size: 0.95rem; }
            .ventas-form-scale .card-body { padding: 1.25rem; }
            .ventas-form-scale .btn { font-size: 0.9rem; }
        </style>

        <form id="ventaForm" th:action="${esEdicion != null ? '/ventas/actualizar/' + venta.id : '/ventas/guardar'}"
              th:object="${venta}" method="post" class="row g-3 ventas-form-scale">

            <!-- Campo oculto para el ID en caso de edición -->
            <input type="hidden" th:field="*{id}" th:if="${venta.id != null}">
            
            <!-- Primera fila dividida para mejorar ancho de campos -->
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="mov" class="form-label">Documento<span class="text-danger">*</span></label>
                    <select class="form-select" name="mov.id" id="mov" required onchange="updateComportamiento(this)" th:disabled="${formularioDeshabilitado}">
                        <option value="">Select document type...</option>
                        <option th:each="tipo : ${tiposDocumento}"
                                th:value="${tipo.id}"
                                th:text="${tipo.descripcion}"
                                th:attr="data-comportamiento=${tipo.comportamiento}"
                                th:selected="${venta.mov != null and venta.mov.id == tipo.id}"></option>
                    </select>
                    <input type="hidden" name="comportamiento" id="comportamiento" th:value="${venta.mov != null ? venta.mov.comportamiento : ''}">
                </div>
                <div class="col-md-2">
                    <label for="movId" class="form-label">OrdenId</label>
                    <input type="number" class="form-control" th:field="*{movId}" id="movId" readonly>
                    <div class="form-text">Auto-generated</div>
                </div>
                <div class="col-md-3">
                    <label for="fechaEmision" class="form-label">Fecha Emision <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" th:field="*{fechaEmision}" id="fechaEmision" required th:disabled="${formularioDeshabilitado}">
                </div>
                <div class="col-md-3">
                    <label for="fecha" class="form-label">Date <span class="text-danger">*</span></label>
                    <input type="date" class="form-control" th:field="*{fecha}" id="fecha" required th:disabled="${formularioDeshabilitado}">
                </div>

            </div>


            
            <div class="row g-3">
                <!-- Segunda fila de campos -->
                <div class="col-md-5">
                    <label for="cliente" class="form-label">Cliente <span class="text-danger">*</span></label>
                    <select class="form-select" th:field="*{cliente.id}" id="cliente" required th:disabled="${formularioDeshabilitado}">
                        <option value="">Seleccione cliente</option>
                        <option th:each="cliente : ${clientes}"
                                th:value="${cliente.id}"
                                th:text="${cliente.codigo + ' - ' + cliente.nombre + ' ' + cliente.apellido}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="condicion" class="form-label">Condicion</label>
                    <select class="form-select" th:field="*{condicion}" id="condicion" th:disabled="${formularioDeshabilitado}">
                        <option th:each="cond : ${T(com.salessystem.model.CondicionPago).values()}"
                                th:value="${cond}"
                                th:text="${cond.descripcion}"></option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="descuento" class="form-label">Descuento</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" class="form-control" th:field="*{descuento}" id="descuento" 
                               step="0.01" min="0" placeholder="0.00" th:disabled="${formularioDeshabilitado}">
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="total" class="form-label">Total</label>
                    <input type="text" class="form-control" th:field="*{total}" id="total" readonly>
                </div>
            </div>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <h5>Detalle de Venta</h5>
                        <button type="button" id="agregarProductoBtn" class="btn btn-primary mb-3" 
                                data-bs-toggle="modal" data-bs-target="#productosModal"
                                th:disabled="${formularioDeshabilitado}">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>

                        <div class="table-responsive">
                            <table id="detalleTable" class="table table-bordered no-datatable">
                                <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                    <th>Acciones</th>
                                </tr>
                                </thead>
                                <tbody>
                                <!-- Detalles existentes (servidor) -->
                                <tr th:each="detalle, iterStat : ${venta.detalles}" th:if="${venta.detalles != null}" th:attr="data-id=${detalle.producto != null ? detalle.producto.id : 0}">
                                    <td th:text="${detalle.producto != null ? detalle.producto.nombre + ' (' + detalle.producto.codigo + ')' : 'Producto no encontrado'}">Producto</td>
                                    <td>
                                        <input type="number" class="form-control cantidad" th:value="${detalle.cantidad}" min="1" style="width: 80px;">
                                    </td>
                                    <td class="precio-unitario" th:text="${'$' + #numbers.formatDecimal(detalle.precioUnitario,1,2)}">$0.00</td>
                                    <td class="subtotal" th:text="${'$' + #numbers.formatDecimal(detalle.subtotal,1,2)}">$0.00</td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-danger eliminar-producto">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                                <tfoot>
                                <tr>
                                    <td colspan="3" class="text-end"><strong>Total:</strong></td>
                                    <td id="totalVenta">$0.00</td>
                                    <td></td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Campos ocultos para los detalles -->
                <div id="detallesHidden"></div>

                <!-- Badge del estatus en la parte inferior -->
                <div class="row mt-4">
                    <div class="col-md-12 d-flex justify-content-center">
                        <div class="status-badge-final">
                            <!-- Campo oculto para el estatus -->
                            <input type="hidden" th:field="*{estatus}" id="estatus">
                            
                            <!-- Badge visual del estatus -->
                            <div class="status-display" id="statusDisplay">
                                <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).PENDIENTE}" 
                                      class="badge bg-warning fs-5 px-4 py-2">
                                    <i class="fas fa-bolt text-warning me-2"></i> 
                                    <span th:text="${T(com.salessystem.model.EstatusVenta).PENDIENTE.descripcion}">Pendiente</span>
                                </span>
                                <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).CONCLUIDO}" 
                                      class="badge bg-success fs-5 px-4 py-2">
                                    <i class="fas fa-check text-white me-2"></i> 
                                    <span th:text="${T(com.salessystem.model.EstatusVenta).CONCLUIDO.descripcion}">Concluido</span>
                                </span>
                                <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).SIN_AFECTAR}" 
                                      class="badge bg-secondary fs-5 px-4 py-2">
                                    <i class="fas fa-clock text-white me-2"></i> 
                                    <span th:text="${T(com.salessystem.model.EstatusVenta).SIN_AFECTAR.descripcion}">Sin Afectar</span>
                                </span>
                                <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).CANCELADO}" 
                                      class="badge bg-danger fs-5 px-4 py-2">
                                    <i class="fas fa-times text-white me-2"></i> 
                                    <span th:text="${T(com.salessystem.model.EstatusVenta).CANCELADO.descripcion}">Cancelado</span>
                                </span>
                                <!-- Badge por defecto para nuevas ventas -->
                                <span th:if="${venta.estatus == null}" class="badge bg-secondary fs-5 px-4 py-2">
                                    <i class="fas fa-clock text-white me-2"></i> Sin Afectar
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
          </form>
        </div>
    </div>

    <!-- Modal para seleccionar productos -->
    <div class="modal fade" id="productosModal" tabindex="-1" aria-labelledby="productosModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productosModalLabel">Seleccionar Productos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" id="searchProduct" class="form-control" placeholder="Buscar producto...">
                    </div>
                    <div class="table-responsive">
                        <table id="productosTableModal" class="table table-hover table-sm">
                            <thead>
                            <tr>
                                <th class="compact-cell">Código</th>
                                <th class="compact-cell">Nombre</th>
                                <th class="compact-cell">Precio</th>
                                <th class="compact-cell">Stock</th>
                                <th class="compact-cell">Acción</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="producto : ${productos}">
                                <td class="compact-cell" th:text="${producto.codigo}"></td>
                                <td class="compact-cell" th:text="${producto.nombre}"></td>
                                <td class="compact-cell" th:text="${'$' + #numbers.formatDecimal(producto.precio, 1, 2)}"></td>
                                <td class="compact-cell" th:text="${producto.stock}"></td>
                                <td class="compact-cell">
                                    <button type="button" class="btn btn-sm btn-primary agregar-producto py-1 px-2"
                                            th:data-id="${producto.id}"
                                            th:data-codigo="${producto.codigo}"
                                            th:data-nombre="${producto.nombre}"
                                            th:data-precio="${producto.precio}"
                                            style="font-size: 0.7rem;">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>


<!-- Scripts específicos para ventas: variables Thymeleaf y carga del JS externo -->
<div layout:fragment="scripts">
    <script th:inline="javascript">
        /*<![CDATA[*/
        window.toastMessage = /*[[${toastMessage}]]*/ null;
        window.toastType = /*[[${toastType}]]*/ 'success';
        window.formularioDeshabilitado = /*[[${formularioDeshabilitado}]]*/ false;
        window.estatusVenta = /*[[${venta.estatus}]]*/ null;
        /*]]>*/
    </script>


</div>
<!-- Mensaje Toast (contenedor global ya existe en layout, pero dejamos contenedor local por compatibilidad) -->
<div aria-live="polite" aria-atomic="true" class="position-relative">
    <div id="toastContainer" class="toast-container position-absolute top-0 start-50 translate-middle-x p-3" style="z-index: 9999">
        <!-- Los toasts se insertan dinámicamente -->
    </div>
</div>
</div>
</body>
</html>
