<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout-nickelfox}">
<head>
    <title>Detalle de Venta - Sales System</title>
</head>
<body>
<div layout:fragment="content">
    <div class="card shadow">
        <div class="card-header py-3">
            <h5 class="card-title mb-0 text-primary">
                <i class="fas fa-receipt me-2"></i>Detalle de Venta #<span th:text="${venta.id}"></span>
            </h5>
        </div>
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-4">
                    <h6 class="fw-bold text-secondary">
                        <i class="fas fa-info-circle me-2"></i>Información de la Venta
                    </h6>
                    <div class="mb-2">
                        <strong>Fecha:</strong> 
                        <span class="text-muted" th:text="${venta.fecha != null ? #dates.format(venta.fecha, 'dd/MM/yyyy') : 'Sin fecha'}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Fecha Emisión:</strong> 
                        <span class="text-muted" th:text="${venta.fechaEmision != null ? #temporals.format(venta.fechaEmision, 'dd/MM/yyyy') : 'Sin fecha'}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Número de Factura:</strong> 
                        <span class="badge bg-secondary" th:text="${venta.numeroFactura}"></span>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="fw-bold text-secondary">
                        <i class="fas fa-file-alt me-2"></i>Documento
                    </h6>
                    <div class="mb-2">
                        <strong>Tipo:</strong> 
                        <span class="badge bg-primary" th:text="${venta.mov?.descripcion ?: 'N/A'}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Número:</strong> 
                        <span class="text-muted" th:text="'#' + ${venta.movId ?: 'N/A'}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Condición:</strong> 
                        <span class="badge bg-info" th:text="${venta.condicion?.descripcion ?: 'N/A'}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Estatus:</strong> 
                        <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).PENDIENTE}" class="badge bg-warning">Pendiente</span>
                        <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).CONCLUIDO}" class="badge bg-success">Concluido</span>
                        <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).SIN_AFECTAR}" class="badge bg-info">Sin Afectar</span>
                        <span th:if="${venta.estatus == T(com.salessystem.model.EstatusVenta).CANCELADO}" class="badge bg-danger">Cancelado</span>
                        <span th:if="${venta.estatus == null}" class="badge bg-secondary">N/A</span>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <h6 class="fw-bold text-secondary">
                        <i class="fas fa-user me-2"></i>Información del Cliente
                    </h6>
                    <div class="mb-2">
                        <strong>Nombre:</strong> 
                        <span class="text-muted" th:text="${venta.cliente.nombre + ' ' + venta.cliente.apellido}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Email:</strong> 
                        <span class="text-muted" th:text="${venta.cliente.email}"></span>
                    </div>
                    <div class="mb-2">
                        <strong>Teléfono:</strong> 
                        <span class="text-muted" th:text="${venta.cliente.telefono}"></span>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header py-3">
                    <h6 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-shopping-cart me-2"></i>Productos Vendidos
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="productosVendidosTable" width="100%" cellspacing="0">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Precio Unitario</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="detalle : ${venta.detalles}">
                                    <td>
                                        <div class="fw-bold" th:text="${detalle.producto.nombre}"></div>
                                        <small class="text-muted" th:text="${'Código: ' + detalle.producto.codigo}"></small>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info" th:text="${detalle.cantidad}"></span>
                                    </td>
                                    <td class="text-end" th:text="${'$' + #numbers.formatDecimal(detalle.precioUnitario, 1, 2)}"></td>
                                    <td class="text-end fw-bold" th:text="${'$' + #numbers.formatDecimal(detalle.subtotal, 1, 2)}"></td>
                                </tr>
                            </tbody>
                            <tfoot class="table-light">
                                <tr th:if="${venta.descuento != null and venta.descuento > 0}">
                                    <td colspan="3" class="text-end">
                                        <i class="fas fa-plus me-2"></i>Subtotal:
                                    </td>
                                    <td class="text-end" th:text="${'$' + #numbers.formatDecimal(venta.total + venta.descuento, 1, 2)}"></td>
                                </tr>
                                <tr th:if="${venta.descuento != null and venta.descuento > 0}">
                                    <td colspan="3" class="text-end text-danger">
                                        <i class="fas fa-minus me-2"></i>Descuento:
                                    </td>
                                    <td class="text-end text-danger" th:text="${'-$' + #numbers.formatDecimal(venta.descuento, 1, 2)}"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">
                                        <i class="fas fa-calculator me-2"></i>Total:
                                    </td>
                                    <td class="text-end fw-bold fs-5 text-success" th:text="${'$' + #numbers.formatDecimal(venta.total, 1, 2)}"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div class="text-end mt-4">
                <a th:href="@{/ventas}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Volver
                </a>
                <a th:href="@{'/ventas/imprimir/' + ${venta.id}}" class="btn btn-primary" target="_blank">
                    <i class="fas fa-print me-1"></i>Imprimir
                </a>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="none">
        $(document).ready(function() {
            // Inicializar DataTable para productos vendidos con modo oscuro
            initializeDataTable('#productosVendidosTable', {
                pageLength: 10,
                ordering: false,
                searching: false,
                lengthChange: false,
                info: false,
                paging: false,
                columnDefs: [
                    { className: 'text-center', targets: [1] },
                    { className: 'text-end', targets: [2, 3] }
                ],
                language: {
                    emptyTable: 'No hay productos en esta venta'
                }
            });
        });
    </script>
</th:block>
</body>
</html>