<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout-nickelfox}">

<head>
    <title>Alertas de Inventario - Sales System</title>
</head>

<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">Alertas de Inventario</h2>
            <p class="text-muted mb-0">Productos con stock bajo y sin existencias</p>
        </div>
        <div class="btn-group" role="group">
            <a th:href="@{/inventario/dashboard}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <button onclick="location.reload()" class="btn btn-outline-primary">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
            </button>
        </div>
    </div>

    <!-- Estadísticas de alertas -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">
                                Sin Stock
                            </div>
                            <div class="h5 mb-0 fw-bold text-dark" th:text="${#lists.size(productosSinStock ?: {})}">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">
                                Stock Bajo
                            </div>
                            <div class="h5 mb-0 fw-bold text-dark" th:text="${#lists.size(productosStockBajo ?: {})}">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row g-0 align-items-center">
                        <div class="col me-2">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">
                                Con Stock Normal
                            </div>
                            <div class="h5 mb-0 fw-bold text-dark" th:text="${(totalProductos ?: 0) - #lists.size(productosSinStock ?: {}) - #lists.size(productosStockBajo ?: {})}">0</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-muted"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos sin stock -->
    <div class="card shadow mb-4" th:if="${!#lists.isEmpty(productosSinStock)}">
        <div class="card-header py-3 bg-danger text-white">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-times-circle me-2"></i>Productos Sin Stock - Atención Urgente
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="sinStockTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Stock</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="producto : ${productosSinStock}">
                            <td class="font-monospace" th:text="${producto.codigo}"></td>
                            <td>
                                <div class="font-weight-bold" th:text="${producto.nombre}"></div>
                                <small class="text-muted" th:text="${producto.descripcion}"></small>
                            </td>
                            <td th:text="${producto.categoria?.nombre ?: 'Sin categoría'}"></td>
                            <td class="text-center">
                                <span class="badge bg-danger text-white" th:text="${producto.stock}">0</span>
                            </td>
                            <td class="text-end" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}"></td>
                            <td class="text-center">
                                <a th:href="@{/inventario/entrada?producto={id}(id=${producto.id})}" class="btn btn-sm btn-success" title="Entrada de inventario">
                                    <i class="fas fa-plus"></i>
                                </a>
                                <a th:href="@{/productos/editar/{id}(id=${producto.id})}" class="btn btn-sm btn-primary" title="Editar producto">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Productos con stock bajo -->
    <div class="card shadow mb-4" th:if="${!#lists.isEmpty(productosStockBajo)}">
        <div class="card-header py-3 bg-warning text-white">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-exclamation-triangle me-2"></i>Productos con Stock Bajo
            </h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="stockBajoTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Stock</th>
                            <th>Stock Mínimo</th>
                            <th>Precio</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="producto : ${productosStockBajo}">
                            <td class="font-monospace" th:text="${producto.codigo}"></td>
                            <td>
                                <div class="font-weight-bold" th:text="${producto.nombre}"></div>
                                <small class="text-muted" th:text="${producto.descripcion}"></small>
                            </td>
                            <td th:text="${producto.categoria?.nombre ?: 'Sin categoría'}"></td>
                            <td class="text-center">
                                <span class="badge bg-warning text-dark" th:text="${producto.stock}"></span>
                            </td>
                            <td class="text-center">
                                <small class="text-muted">≤ 10</small>
                            </td>
                            <td class="text-end" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}"></td>
                            <td class="text-center">
                                <a th:href="@{/inventario/entrada?producto={id}(id=${producto.id})}" class="btn btn-sm btn-success" title="Entrada de inventario">
                                    <i class="fas fa-plus"></i>
                                </a>
                                <a th:href="@{/productos/editar/{id}(id=${producto.id})}" class="btn btn-sm btn-primary" title="Editar producto">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Mensaje cuando no hay alertas -->
    <div class="card shadow text-center py-5" th:if="${#lists.isEmpty(productosSinStock) and #lists.isEmpty(productosStockBajo)}">
        <div class="card-body">
            <i class="fas fa-check-circle fa-5x text-success mb-4"></i>
            <h4 class="text-success">¡Excelente!</h4>
            <p class="text-muted mb-4">No hay alertas de inventario en este momento. Todos los productos tienen stock suficiente.</p>
            <a th:href="@{/inventario/dashboard}" class="btn btn-primary">
                <i class="fas fa-arrow-left me-1"></i>Volver al Dashboard
            </a>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <style>
        /* DataTables Dark Mode - Usando el selector correcto [data-theme="dark"] */
        [data-theme="dark"] .dataTables_wrapper {
            color: #B7C5D3 !important;
        }
        
        /* Filtros y controles */
        [data-theme="dark"] .dataTables_filter input {
            background-color: #2d3748 !important;
            border: 1px solid #4a5568 !important;
            color: #B7C5D3 !important;
        }
        
        [data-theme="dark"] .dataTables_length select {
            background-color: #2d3748 !important;
            border: 1px solid #4a5568 !important;
            color: #B7C5D3 !important;
        }
        
        /* Cabeceras de tabla */
        [data-theme="dark"] .table thead th {
            background-color: #2d3748 !important;
            border-color: #4a5568 !important;
            color: #FFFFFF !important;
        }
        
        /* Celdas de tabla */
        [data-theme="dark"] .table td {
            background-color: #2a3547 !important;
            border-color: #4a5568 !important;
            color: #B7C5D3 !important;
        }
        
        [data-theme="dark"] .table tbody tr {
            background-color: #2a3547 !important;
        }
        
        [data-theme="dark"] .table tbody tr:nth-of-type(odd) td {
            background-color: #1a202c !important;
        }
        
        /* Hover effect */
        [data-theme="dark"] .table-hover tbody tr:hover td {
            background-color: #4a5568 !important;
        }
        
        /* Paginación */
        [data-theme="dark"] .dataTables_paginate .paginate_button {
            background: #2d3748 !important;
            border: 1px solid #4a5568 !important;
            color: #B7C5D3 !important;
        }
        
        [data-theme="dark"] .dataTables_paginate .paginate_button:hover {
            background: #4a5568 !important;
            border-color: #B7C5D3 !important;
            color: #FFFFFF !important;
        }
        
        [data-theme="dark"] .dataTables_paginate .paginate_button.current {
            background: #5D87FF !important;
            border-color: #5D87FF !important;
            color: #FFFFFF !important;
        }
        
        [data-theme="dark"] .dataTables_paginate .paginate_button.disabled {
            background: #1a202c !important;
            border-color: #2d3748 !important;
            color: #4a5568 !important;
        }
        
        /* Info y labels */
        [data-theme="dark"] .dataTables_info,
        [data-theme="dark"] .dataTables_filter label,
        [data-theme="dark"] .dataTables_length label {
            color: #B7C5D3 !important;
        }
        
        /* Mensaje cuando no hay datos */
        [data-theme="dark"] .dataTables_empty {
            color: #4a5568 !important;
        }
        
        /* Wrapper general */
        [data-theme="dark"] .dataTables_wrapper .row {
            color: #B7C5D3;
        }
        
        /* Controles de búsqueda focus */
        [data-theme="dark"] .dataTables_filter input:focus,
        [data-theme="dark"] .dataTables_length select:focus {
            background-color: #2d3748 !important;
            border-color: #5D87FF !important;
            box-shadow: 0 0 0 0.25rem rgba(93, 135, 255, 0.25) !important;
            color: #FFFFFF !important;
        }
        
        /* Ajustes adicionales para compatibilidad con NickelFox */
        [data-theme="dark"] .card {
            background-color: var(--white) !important;
            border-color: var(--border-color) !important;
        }
        
        [data-theme="dark"] .table {
            --bs-table-bg: var(--white);
            --bs-table-border-color: var(--border-color);
        }
    </style>
    
    <script>
        $(document).ready(function() {
            // Configuración común para DataTables
            const dataTableConfig = {
                responsive: true,
                pageLength: 10,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ entradas",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                    infoEmpty: "No hay entradas para mostrar",
                    infoFiltered: "(filtrado de _MAX_ entradas totales)",
                    paginate: {
                        first: "Primero",
                        last: "Último",
                        next: "Siguiente",
                        previous: "Anterior"
                    },
                    zeroRecords: "No se encontraron registros que coincidan con la búsqueda",
                    emptyTable: "No hay datos disponibles en la tabla"
                },
                drawCallback: function() {
                    // Forzar aplicación de estilos después de cada redibujado
                    applyDarkModeStyles();
                }
            };

            // Función para aplicar estilos de modo oscuro
            function applyDarkModeStyles() {
                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                
                if (isDarkMode) {
                    // Forzar recarga de estilos para DataTable
                    $('.dataTables_wrapper').addClass('dark-mode-applied');
                } else {
                    $('.dataTables_wrapper').removeClass('dark-mode-applied');
                }
            }

            // Inicializar DataTables para tabla sin stock
            if ($('#sinStockTable tbody tr').length > 0) {
                $('#sinStockTable').DataTable({
                    ...dataTableConfig,
                    order: [0, 'asc'],
                    columnDefs: [
                        { orderable: false, targets: [5] },
                        { className: "text-center", targets: [3, 5] },
                        { className: "text-end", targets: [4] }
                    ]
                });
            }

            // Inicializar DataTables para tabla stock bajo
            if ($('#stockBajoTable tbody tr').length > 0) {
                $('#stockBajoTable').DataTable({
                    ...dataTableConfig,
                    order: [3, 'asc'],
                    columnDefs: [
                        { orderable: false, targets: [6] },
                        { className: "text-center", targets: [3, 4, 6] },
                        { className: "text-end", targets: [5] }
                    ]
                });
            }
            
            // Aplicar estilos iniciales
            applyDarkModeStyles();
            
            // Observar cambios en el tema (usando data-theme en lugar de data-bs-theme)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
                        setTimeout(applyDarkModeStyles, 100);
                    }
                });
            });
            
            observer.observe(document.documentElement, {
                attributes: true,
                attributeFilter: ['data-theme']
            });
        });
    </script>
</th:block>
</body>
</html>

