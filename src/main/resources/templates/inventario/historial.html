<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout-nickelfox}">

<head>
    <title>Historial de Inventario - Sales System</title>
</head>

<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">Historial de Inventario</h2>
            <p class="text-muted mb-0">Movimientos del producto: <span class="fw-bold" th:text="${producto.nombre}">Producto</span></p>
        </div>
        <div class="btn-group" role="group">
            <a th:href="@{/inventario/movimientos}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-plus me-1"></i>Nuevo Movimiento
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" th:href="@{'/inventario/entrada?producto=' + ${producto.id}}">
                        <i class="fas fa-plus text-success me-2"></i>Entrada
                    </a></li>
                    <li><a class="dropdown-item" th:href="@{'/inventario/salida?producto=' + ${producto.id}}">
                        <i class="fas fa-minus text-danger me-2"></i>Salida
                    </a></li>
                    <li><a class="dropdown-item" th:href="@{'/inventario/ajuste?producto=' + ${producto.id}}">
                        <i class="fas fa-edit text-warning me-2"></i>Ajuste
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Información del producto -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-box me-2"></i>Información del Producto
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="product-info">
                        <h5 class="card-title" th:text="${producto.nombre}">Producto</h5>
                        <p class="text-muted mb-2" th:text="${producto.descripcion}">Descripción</p>
                        <p class="mb-1"><strong>Código:</strong> <span class="font-monospace" th:text="${producto.codigo}"></span></p>
                        <p class="mb-1"><strong>Categoría:</strong> <span th:text="${producto.categoria?.nombre ?: 'Sin categoría'}"></span></p>
                        <p class="mb-1"><strong>Precio:</strong> <span th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}"></span></p>
                    </div>
                </div>
                <div class="col-md-9">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="card border-left-primary h-100 py-3">
                                <div class="card-body">
                                    <div class="text-xs fw-bold text-primary text-uppercase mb-1">Stock Actual</div>
                                    <div class="h4 mb-0 fw-bold text-dark" th:text="${producto.stock}">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-left-success h-100 py-3">
                                <div class="card-body">
                                    <div class="text-xs fw-bold text-success text-uppercase mb-1">Total Entradas</div>
                                    <div class="h4 mb-0 fw-bold text-dark" th:text="${totalEntradas ?: 0}">0</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-left-danger h-100 py-3">
                                <div class="card-body">
                                    <div class="text-xs fw-bold text-danger text-uppercase mb-1">Total Salidas</div>
                                    <div class="h4 mb-0 fw-bold text-dark" th:text="${totalSalidas ?: 0}">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-filter me-2"></i>Filtros
            </h6>
        </div>
        <div class="card-body">
            <form method="get" th:action="@{'/inventario/historial/' + ${producto.id}}">
                <div class="row">
                    <div class="col-md-3">
                        <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="form-control" th:value="${fechaInicio}">
                    </div>
                    <div class="col-md-3">
                        <label for="fechaFin" class="form-label">Fecha Fin</label>
                        <input type="date" id="fechaFin" name="fechaFin" class="form-control" th:value="${fechaFin}">
                    </div>
                    <div class="col-md-3">
                        <label for="tipoMovimiento" class="form-label">Tipo de Movimiento</label>
                        <select id="tipoMovimiento" name="tipo" class="form-select">
                            <option value="">Todos</option>
                            <option value="ENTRADA" th:selected="${param.tipo != null and param.tipo[0] == 'ENTRADA'}">Entrada</option>
                            <option value="SALIDA" th:selected="${param.tipo != null and param.tipo[0] == 'SALIDA'}">Salida</option>
                            <option value="AJUSTE" th:selected="${param.tipo != null and param.tipo[0] == 'AJUSTE'}">Ajuste</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <a th:href="@{'/inventario/historial/' + ${producto.id}}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Limpiar
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de movimientos -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-list me-2"></i>Historial de Movimientos
            </h6>
        </div>
        <div class="card-body">
            <div th:if="${!#lists.isEmpty(movimientos)}">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover" id="historialTable" width="100%" cellspacing="0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                                <th>Stock Anterior</th>
                                <th>Stock Final</th>
                                <th>Observaciones</th>
                                <th>Usuario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="movimiento : ${movimientos}">
                                <td class="text-nowrap" th:text="${#temporals.format(movimiento.fechaMovimiento, 'dd/MM/yyyy HH:mm')}"></td>
                                <td class="text-center">
                                    <span th:switch="${movimiento.tipoMovimiento.toString()}">
                                        <span th:case="'ENTRADA'" class="badge bg-success">
                                            <i class="fas fa-plus me-1"></i>Entrada
                                        </span>
                                        <span th:case="'SALIDA'" class="badge bg-danger">
                                            <i class="fas fa-minus me-1"></i>Salida
                                        </span>
                                        <span th:case="'AJUSTE'" class="badge bg-warning text-dark">
                                            <i class="fas fa-edit me-1"></i>Ajuste
                                        </span>
                                    </span>
                                </td>
                                <td class="text-center fw-bold" th:text="${movimiento.cantidad}"></td>
                                <td class="text-end" th:text="'$' + ${#numbers.formatDecimal(movimiento.precioUnitario, 1, 2)}"></td>
                                <td class="text-end fw-bold" th:text="'$' + ${#numbers.formatDecimal(movimiento.cantidad * movimiento.precioUnitario, 1, 2)}"></td>
                                <td class="text-center" th:text="${movimiento.stockAnterior}"></td>
                                <td class="text-center">
                                    <span class="badge bg-primary" th:text="${movimiento.stockResultante}"></span>
                                </td>
                                <td>
                                    <small th:text="${movimiento.observaciones ?: '-'}" class="text-muted"></small>
                                </td>
                                <td th:text="${movimiento.usuario?.nombre ?: 'Sistema'}"></td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            th:onclick="|verDetalle(${movimiento.id})|" 
                                            title="Ver detalle">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div th:if="${#lists.isEmpty(movimientos)}" class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No hay movimientos registrados</h5>
                <p class="text-muted">No se encontraron movimientos para este producto con los filtros seleccionados.</p>
                <a th:href="@{'/inventario/entrada?producto=' + ${producto.id}}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Registrar Primer Movimiento
                </a>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/js/main.js}"></script>
<script th:inline="none">
$(document).ready(function() {
    // Inicializar DataTable con preset para movimientos y modo oscuro
    initializeDataTableWithPreset('#historialTable', 'movimientos', {
        pageLength: 25,
        language: {
            search: 'Buscar en historial:',
            lengthMenu: 'Mostrar _MENU_ movimientos por página',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ movimientos',
            infoEmpty: 'No hay movimientos en el historial',
            infoFiltered: '(filtrado de _MAX_ movimientos totales)',
            zeroRecords: 'No se encontraron movimientos que coincidan con la búsqueda',
            emptyTable: 'No hay movimientos registrados en el historial'
        }
    });
});

function verDetalle(movimientoId) {
    // Aquí puedes implementar un modal o redirección para ver detalles del movimiento
    alert('Ver detalle del movimiento ID: ' + movimientoId);
}
</script>
</body>
</html>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-box"></i> Información del Producto
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5 th:text="${producto.nombre}"></h5>
                                        <p class="text-muted" th:text="${producto.descripcion}"></p>
                                        <p>
                                            <strong>Código:</strong> 
                                            <code th:text="${producto.codigo}"></code>
                                        </p>
                                        <p>
                                            <strong>Categoría:</strong> 
                                            <span th:if="${producto.categoria != null}" 
                                                  th:text="${producto.categoria.nombre}"
                                                  class="badge bg-secondary"></span>
                                            <span th:unless="${producto.categoria != null}" 
                                                  class="text-muted">Sin categoría</span>
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p>
                                            <strong>Precio:</strong> 
                                            <span class="h5 text-success" th:text="'$' + ${#numbers.formatDecimal(producto.precio, 1, 2)}"></span>
                                        </p>
                                        <p>
                                            <strong>Stock Actual:</strong> 
                                            <span class="h4" 
                                                  th:classappend="${producto.stock <= 0} ? 'text-danger' : 
                                                                 (${producto.stock <= 10} ? 'text-warning' : 'text-success')"
                                                  th:text="${producto.stock} + ' unidades'">
                                            </span>
                                        </p>
                                        <div th:if="${producto.stock <= 0}">
                                            <span class="badge bg-danger fs-6">
                                                <i class="fas fa-exclamation-triangle"></i> Sin Stock
                                            </span>
                                        </div>
                                        <div th:if="${producto.stock > 0 && producto.stock <= 10}">
                                            <span class="badge bg-warning fs-6">
                                                <i class="fas fa-exclamation-circle"></i> Stock Bajo
                                            </span>
                                        </div>
                                        <div th:if="${producto.stock > 10}">
                                            <span class="badge bg-success fs-6">
                                                <i class="fas fa-check-circle"></i> Stock Adecuado
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="product-img">
                                    <img src="/static/images/box-icon.png" alt="Product" class="img-fluid rounded" style="max-width: 150px;"
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22150%22 height=%22150%22 viewBox=%220 0 24 24%22 fill=%22%23007bff%22><path d=%22M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5%22/></svg>'">
                                </div>
                                <div class="mt-3">
                                    <a th:href="@{'/productos/editar/' + ${producto.id}}" class="btn btn-outline-primary">
                                        <i class="fas fa-edit"></i> Editar Producto
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estadísticas rápidas -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-chart-line text-primary fa-2x mb-2"></i>
                        <h5 class="text-primary" th:text="${#lists.size(movimientos)}">0</h5>
                        <small class="text-muted">Total Movimientos</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-plus-circle text-success fa-2x mb-2"></i>
                        <h5 class="text-success" th:text="${#lists.size(movimientos.?[tipo.name() == 'ENTRADA'])}">0</h5>
                        <small class="text-muted">Entradas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-minus-circle text-danger fa-2x mb-2"></i>
                        <h5 class="text-danger" th:text="${#lists.size(movimientos.?[tipo.name() == 'SALIDA'])}">0</h5>
                        <small class="text-muted">Salidas</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-edit text-warning fa-2x mb-2"></i>
                        <h5 class="text-warning" th:text="${#lists.size(movimientos.?[tipo.name().startsWith('AJUSTE')])}">0</h5>
                        <small class="text-muted">Ajustes</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de movimientos -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-history"></i> Historial de Movimientos
                            <small class="text-muted">(<span th:text="${#lists.size(movimientos)}">0</span> registros)</small>
                        </h4>
                        <div class="card-tools">
                            <button class="btn btn-sm btn-outline-success" onclick="exportarHistorial()">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="historialTable">
                                <thead>
                                    <tr>
                                        <th width="120">Fecha</th>
                                        <th width="120">Tipo</th>
                                        <th width="80">Cantidad</th>
                                        <th width="100">Stock Anterior</th>
                                        <th width="100">Stock Nuevo</th>
                                        <th width="100">Diferencia</th>
                                        <th width="100">Costo</th>
                                        <th>Motivo</th>
                                        <th>Usuario</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:if="${#lists.isEmpty(movimientos)}">
                                        <td colspan="10" class="text-center text-muted py-4">
                                            <i class="fas fa-inbox fa-2x"></i>
                                            <br>
                                            No se encontraron movimientos para este producto
                                        </td>
                                    </tr>
                                    <tr th:each="movimiento : ${movimientos}">
                                        <td>
                                            <small th:text="${#temporals.format(movimiento.fechaMovimiento, 'dd/MM/yyyy')}"></small>
                                            <br>
                                            <small class="text-muted" th:text="${#temporals.format(movimiento.fechaMovimiento, 'HH:mm:ss')}"></small>
                                        </td>
                                        <td>
                                            <span class="badge" 
                                                  th:classappend="${movimiento.tipo.name() == 'ENTRADA'} ? 'bg-success' : 
                                                                 (${movimiento.tipo.name() == 'SALIDA'} ? 'bg-danger' : 
                                                                 (${movimiento.tipo.name() == 'AJUSTE_POSITIVO'} ? 'bg-info' : 
                                                                 (${movimiento.tipo.name() == 'AJUSTE_NEGATIVO'} ? 'bg-warning' : 'bg-secondary')))"
                                                  th:text="${movimiento.tipo.descripcion}">
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <span th:if="${movimiento.tipo.name() == 'ENTRADA' || movimiento.tipo.name() == 'AJUSTE_POSITIVO'}" 
                                                  class="text-success fw-bold">+</span>
                                            <span th:if="${movimiento.tipo.name() == 'SALIDA' || movimiento.tipo.name() == 'AJUSTE_NEGATIVO'}" 
                                                  class="text-danger fw-bold">-</span>
                                            <span th:text="${movimiento.cantidad}"></span>
                                        </td>
                                        <td class="text-center">
                                            <span th:text="${movimiento.stockAnterior}"
                                                  th:classappend="${movimiento.stockAnterior <= 0} ? 'text-danger' : 
                                                                 (${movimiento.stockAnterior <= 10} ? 'text-warning' : '')">
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <strong th:text="${movimiento.stockNuevo}"
                                                    th:classappend="${movimiento.stockNuevo <= 0} ? 'text-danger' : 
                                                                   (${movimiento.stockNuevo <= 10} ? 'text-warning' : 'text-success')">
                                            </strong>
                                        </td>
                                        <td class="text-center">
                                            <span th:with="diferencia=${movimiento.stockNuevo - movimiento.stockAnterior}"
                                                  th:classappend="${diferencia > 0} ? 'text-success' : 'text-danger'"
                                                  th:text="${diferencia > 0 ? '+' + diferencia : diferencia}">
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            <span th:if="${movimiento.costo != null}" 
                                                  th:text="'$' + ${#numbers.formatDecimal(movimiento.costo, 1, 2)}"></span>
                                            <span th:unless="${movimiento.costo != null}" class="text-muted">-</span>
                                        </td>
                                        <td>
                                            <span th:text="${movimiento.motivo}"></span>
                                        </td>
                                        <td>
                                            <small th:text="${movimiento.usuario != null ? movimiento.usuario.username : 'Sistema'}"></small>
                                        </td>
                                        <td>
                                            <span th:if="${movimiento.observaciones != null && !#strings.isEmpty(movimiento.observaciones)}"
                                                  th:text="${movimiento.observaciones}"></span>
                                            <span th:unless="${movimiento.observaciones != null && !#strings.isEmpty(movimiento.observaciones)}"
                                                  class="text-muted">-</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de evolución del stock (placeholder) -->
        <div class="row mt-4" th:if="${!#lists.isEmpty(movimientos)}">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">
                            <i class="fas fa-chart-area"></i> Evolución del Stock
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="text-center py-4">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Gráfico de evolución del stock en desarrollo</p>
                            <p class="text-muted">Mostrará la evolución del stock a lo largo del tiempo</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="none">
        $(document).ready(function() {
            // Inicializar DataTable con preset para movimientos y modo oscuro
            initializeDataTableWithPreset('#historialTable', 'movimientos', {
                pageLength: 15,
                columnDefs: [
                    { targets: [2, 3, 4, 5, 6], className: 'text-center' },
                    { targets: [7, 8, 9], width: '15%' }
                ],
                language: {
                    search: 'Buscar en historial:',
                    lengthMenu: 'Mostrar _MENU_ movimientos por página',
                    info: 'Mostrando _START_ a _END_ de _TOTAL_ movimientos',
                    infoEmpty: 'No hay movimientos en el historial',
                    infoFiltered: '(filtrado de _MAX_ movimientos totales)',
                    zeroRecords: 'No se encontraron movimientos que coincidan con la búsqueda',
                    emptyTable: 'No hay movimientos registrados en el historial'
                }
            });

            // Animación de contadores
            animateCounters();
        });

        function animateCounters() {
            $('.card h5').each(function() {
                const $this = $(this);
                const countTo = parseInt($this.text());
                
                if (!isNaN(countTo)) {
                    $({ countNum: 0 }).animate({
                        countNum: countTo
                    }, {
                        duration: 1000,
                        easing: 'swing',
                        step: function() {
                            $this.text(Math.floor(this.countNum));
                        },
                        complete: function() {
                            $this.text(countTo);
                        }
                    });
                }
            });
        }

        function exportarHistorial() {
            // Función para exportar historial
            const productoCodigo = /*[[${producto.codigo}]]*/ '';
            const productoNombre = /*[[${producto.nombre}]]*/ '';
            
            if (confirm(`¿Desea exportar el historial de inventario del producto "${productoNombre}"?`)) {
                // Implementar exportación
                alert('Funcionalidad de exportación en desarrollo');
            }
        }

        // Tooltips para badges de stock
        $('[data-bs-toggle="tooltip"]').tooltip();
    </script>
</th:block>
</body>
</html>
