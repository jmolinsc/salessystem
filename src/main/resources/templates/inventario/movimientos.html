<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout-nickelfox}">

<head>
    <title>Movimientos de Inventario - Sales System</title>
</head>

<body>
<div layout:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h3 mb-1">Movimientos de Inventario</h2>
            <p class="text-muted mb-0">Historial completo de movimientos del inventario</p>
        </div>
        <div class="btn-group" role="group">
            <a th:href="@{/inventario}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Volver
            </a>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-plus me-1"></i>Nuevo Movimiento
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" th:href="@{/inventario/entrada}">
                        <i class="fas fa-plus text-success me-2"></i>Entrada
                    </a></li>
                    <li><a class="dropdown-item" th:href="@{/inventario/salida}">
                        <i class="fas fa-minus text-danger me-2"></i>Salida
                    </a></li>
                    <li><a class="dropdown-item" th:href="@{/inventario/ajuste}">
                        <i class="fas fa-balance-scale text-warning me-2"></i>Ajuste
                    </a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <!-- Filtros de búsqueda -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
            </h6>
        </div>
        <div class="card-body">
            <form method="get" th:action="@{/inventario/movimientos}" class="row g-3">
                <div class="col-md-3">
                    <label for="productoId" class="form-label">Producto</label>
                    <select class="form-select" id="productoId" name="productoId">
                        <option value="">Todos los productos</option>
                        <option th:each="producto : ${productos}" 
                                th:value="${producto.id}" 
                                th:text="${producto.codigo + ' - ' + producto.nombre}"
                                th:selected="${producto.id == filtroProducto}">
                        </option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="tipo" class="form-label">Tipo de Movimiento</label>
                    <select class="form-select" id="tipo" name="tipo">
                        <option value="">Todos los tipos</option>
                        <option th:each="tipoMov : ${tiposMovimiento}" 
                                th:value="${tipoMov}" 
                                th:text="${tipoMov.descripcion}"
                                th:selected="${tipoMov == filtroTipo}">
                        </option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" id="fechaInicio" name="fechaInicio" 
                           th:value="${filtroFechaInicio}">
                </div>

                <div class="col-md-2">
                    <label for="fechaFin" class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" id="fechaFin" name="fechaFin" 
                           th:value="${filtroFechaFin}">
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <div class="btn-group w-100">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Filtrar
                        </button>
                        <a th:href="@{/inventario/movimientos}" class="btn btn-outline-secondary" title="Limpiar filtros">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de movimientos -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 fw-bold text-primary">
                <i class="fas fa-list me-2"></i>Historial de Movimientos
                <span class="badge bg-secondary ms-2" th:text="${#lists.size(movimientos) + ' registros'}">0 registros</span>
            </h6>
            <a href="#" class="btn btn-sm btn-success" id="exportarBtn">
                <i class="fas fa-download me-1"></i>Exportar
            </a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm" id="movimientosTable" width="100%" cellspacing="0">
                    <thead class="table-light">
                        <tr>
                            <th class="compact-cell">Fecha</th>
                            <th class="compact-cell">Producto</th>
                            <th class="compact-cell">Tipo</th>
                            <th class="compact-cell">Cant.</th>
                            <th class="compact-cell">Stock Ant.</th>
                            <th class="compact-cell">Stock Nuevo</th>
                            <th class="compact-cell">Costo</th>
                            <th class="compact-cell">Motivo</th>
                            <th class="compact-cell">Usuario</th>
                            <th class="compact-cell">Acc.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="movimiento : ${movimientos}">
                            <td class="compact-cell" th:text="${#temporals.format(movimiento.fechaMovimiento, 'dd/MM/yy HH:mm')}"></td>
                            <td class="compact-cell">
                                <div class="fw-bold small" th:text="${movimiento.producto.nombre}"></div>
                                <small class="text-muted" th:text="${movimiento.producto.codigo}"></small>
                            </td>
                            <td class="compact-cell">
                                <span class="badge" 
                                      th:classappend="${movimiento.tipo.name() == 'ENTRADA'} ? 'bg-success' : 
                                                     (${movimiento.tipo.name() == 'SALIDA'} ? 'bg-danger' : 
                                                     (${movimiento.tipo.name() == 'VENTA'} ? 'bg-info' : 'bg-warning'))"
                                      th:text="${movimiento.tipo.descripcion}"></span>
                            </td>
                            <td class="text-center compact-cell">
                                <span th:classappend="${movimiento.tipo.name() == 'ENTRADA' or movimiento.tipo.name() == 'AJUSTE_POSITIVO'} ? 'text-success' : 'text-danger'"
                                      th:text="${movimiento.tipo.name() == 'ENTRADA' or movimiento.tipo.name() == 'AJUSTE_POSITIVO' ? '+' + movimiento.cantidad : '-' + movimiento.cantidad}"></span>
                            </td>
                            <td class="text-center compact-cell" th:text="${movimiento.stockAnterior}"></td>
                            <td class="text-center fw-bold compact-cell" th:text="${movimiento.stockNuevo}"></td>
                            <td class="text-end compact-cell" th:text="${movimiento.costo != null ? '$' + #numbers.formatDecimal(movimiento.costo, 1, 2) : '-'}"></td>
                            <td class="compact-cell">
                                <div class="small" th:text="${movimiento.motivo}"></div>
                                <small class="text-muted" th:if="${movimiento.observaciones != null and !#strings.isEmpty(movimiento.observaciones)}" th:text="${movimiento.observaciones}"></small>
                            </td>
                            <td class="compact-cell small" th:text="${movimiento.usuario.nombre}"></td>
                            <td class="text-center compact-cell">
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        th:onclick="'verDetalle(' + ${movimiento.id} + ')'" title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        $(document).ready(function() {
            // Verificar si hay datos en la tabla
            const movimientos = /*[[${movimientos}]]*/ [];
            const hasData = movimientos && movimientos.length > 0;
            
            console.log('Movimientos count:', movimientos.length);
            console.log('Has data:', hasData);
            
            if (hasData) {
                // Configuración completa para tabla con datos
                try {
                    $('#movimientosTable').DataTable({
                        responsive: true,
                        pageLength: 25,
                        lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]],
                        order: [[0, 'desc']], // Ordenar por fecha descendente
                        columnDefs: [
                            { targets: [3, 4, 5], className: 'text-center' }, // Centrar cantidades y stocks
                            { targets: [6], className: 'text-end' }, // Alinear costo a la derecha
                            { targets: [9], orderable: false } // Deshabilitar ordenamiento en acciones
                        ],
                        language: {
                            decimal: "",
                            emptyTable: "No hay movimientos registrados en el sistema",
                            info: "Mostrando _START_ a _END_ de _TOTAL_ movimientos",
                            infoEmpty: "Mostrando 0 a 0 de 0 movimientos",
                            infoFiltered: "(filtrado de _MAX_ movimientos totales)",
                            infoPostFix: "",
                            thousands: ",",
                            lengthMenu: "Mostrar _MENU_ movimientos",
                            loadingRecords: "Cargando...",
                            processing: "Procesando...",
                            search: "Buscar:",
                            zeroRecords: "No se encontraron movimientos que coincidan con la búsqueda",
                            paginate: {
                                first: "Primero",
                                last: "Último",
                                next: "Siguiente",
                                previous: "Anterior"
                            },
                            aria: {
                                sortAscending: ": activar para ordenar la columna de manera ascendente",
                                sortDescending: ": activar para ordenar la columna de manera descendente"
                            }
                        }
                    });
                    console.log('DataTable inicializado correctamente');
                } catch (error) {
                    console.error('Error al inicializar DataTable:', error);
                }
            } else {
                console.log('No hay datos, mostrando mensaje vacío');
                // Mostrar mensaje cuando no hay datos
                $('#movimientosTable tbody').html(
                    '<tr><td colspan="10" class="text-center text-muted py-4">' +
                    '<i class="fas fa-inbox fa-3x mb-3 d-block"></i>' +
                    'No se encontraron movimientos con los filtros aplicados' +
                    '</td></tr>'
                );
            }

            // Eventos adicionales
            $('#exportarBtn').on('click', function(e) {
                e.preventDefault();
                exportarMovimientos();
            });
        });

        function verDetalle(id) {
            alert('Ver detalle del movimiento #' + id);
        }

        function exportarMovimientos() {
            const table = $('#movimientosTable').DataTable();
            const data = table.data().toArray();
            alert('Funcionalidad de exportación - ' + data.length + ' registros encontrados');
        }
    </script>
</th:block>
</body>
</html>
